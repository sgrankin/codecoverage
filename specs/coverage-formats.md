# Coverage Formats

## Supported Formats

The action supports four coverage file formats:

### 1. LCOV (default)

- File extension: typically `.info` or `lcov.info`
- Parser: Custom (inlined from `lcov-parse` to reduce dependencies)
- Common with: JavaScript/TypeScript (Jest, Vitest), C/C++ (gcov)

### 2. Cobertura XML

- File extension: `.xml`
- Parser: Custom XML parsing with `fast-xml-parser`
- Common with: Java, Python (coverage.py), .NET

**Package extraction**: Cobertura XML has native package support via `<package name="...">` elements. We extract this and preserve it in the coverage data.

### 3. Go Coverage

- File extension: typically `.out` or `coverage.out`
- Parser: `golang-cover-parse` npm package
- Generated by: `go test -coverprofile`

### 4. SimpleCov (Ruby)

- File extension: `.json` (typically `coverage.json` or `.resultset.json`)
- Parser: Custom JSON parser
- Generated by: SimpleCov with `simplecov_json_formatter`

**Supported formats:**

1. **simplecov_json_formatter output** (`coverage.json`):
   ```json
   {
     "meta": {"simplecov_version": "0.21.2"},
     "coverage": {
       "/path/to/file.rb": {
         "lines": [null, 1, 1, 0, null, 2]
       }
     }
   }
   ```

2. **.resultset.json** (internal format with multiple test suites):
   ```json
   {
     "RSpec": {
       "coverage": {
         "/path/to/file.rb": [null, 1, 0, null]
       },
       "timestamp": 1234567890
     }
   }
   ```

**Lines array**: `null` = non-executable, `0` = uncovered, `>0` = hit count.

When parsing `.resultset.json`, coverage from multiple test suites is merged (max hit count per line).

## Internal Data Structure

All parsers produce a normalized `CoverageParsed` array:

```typescript
type CoverageEntry = {
  file: string      // Relative file path
  title: string     // Display name
  package?: string  // Package name (from Cobertura, undefined for others)
  lines: {
    found: number   // Total executable lines
    hit: number     // Lines with coverage
    details: {
      line: number  // Line number
      hit: number   // Hit count (0 = uncovered)
    }[]
  }
}

type CoverageParsed = CoverageEntry[]
```

## Removed Formats

### Clover XML

Clover support was removed because:
- The `@cvrg-report/clover-json` package had issues with ESM imports
- Limited real-world usage compared to other formats
- Cobertura serves similar use cases (Java/JVM ecosystem)

## Adding New Formats

To add a new coverage format:

1. Create a parser in `src/utils/<format>.ts`
2. Return `CoverageParsed` array with normalized data
3. Add format to `SUPPORTED_FORMATS` in `src/action.ts`
4. Add parsing logic in the format switch statement
5. Add tests with fixture files in `__tests__/fixtures/`
6. Update README.md and this spec
