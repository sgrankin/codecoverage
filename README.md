![Build Status](https://github.com/sgrankin/codecoverage/actions/workflows/test.yml/badge.svg)

# Code Coverage Annotation

Reviewing test coverage information for a whole repository can be overwhelming
and hard to take action on. It's much more useful to catch gaps in coverage as
they're introduced to a repo, right in the context of pull requests!

All processing is done within Github Actions, no data is sent to an external server.

> **Note**: This is a fork of [ggilder/codecoverage](https://github.com/ggilder/codecoverage) with updated dependencies and additional improvements.

## Sample PR Annotation
<img width="1069" alt="Screen Shot 2022-06-26 at 7 11 21 PM" src="https://user-images.githubusercontent.com/23582455/175847244-dbed2fb3-70be-4bcd-a7d0-64197951c517.png">


## Inputs

| Key                  | Required | Default                  | Description                                                                                           |
| -------------------- | -------- | ------------------------ | ----------------------------------------------------------------------------------------------------- |
| `GITHUB_TOKEN`       | **yes**  | -                        | Github Token generated by Github Action workflow. You can pass this in as `${{secrets.GITHUB_TOKEN}}` |
| `GITHUB_BASE_URL`    | **no**   | `https://api.github.com` | Base URL for GitHub API. Required for GitHub Enterprise Server or Cloud.                              |
| `COVERAGE_FILE_PATH` | **yes**  | -                        | Path to coverage file(s). Supports glob patterns (including `**`) and multiple paths separated by newlines. |
| `COVERAGE_FORMAT`    | **no**   | `lcov`                   | Format of coverage file. May be `lcov`, `cobertura`, or `go`                                          |
| `DEBUG`              | **no**   | -                        | Log debugging information. Comma-separated list of possible values `coverage`, `pr_lines_added`       |
| `STEP_SUMMARY`       | **no**   | `true`                   | Write a summary to the GitHub Actions step summary. Set to `false` to disable.                        |

## Outputs

| Key                   | Description                                                    |
| --------------------- | -------------------------------------------------------------- |
| `coverage_percentage` | Overall code coverage percentage (e.g., `85.50`)               |
| `files_analyzed`      | Number of files with coverage data                             |
| `annotation_count`    | Number of annotations created for uncovered lines in the PR    |

## Usage

Add the action to your workflow file like so, replacing the file path and
coverage format with values appropriate for your repo:

```yaml
- name: Code Coverage Annotation
  uses: sgrankin/codecoverage@main
  with:
    GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
    COVERAGE_FILE_PATH: "./coverage/lcov.info"
    COVERAGE_FORMAT: "lcov"
```

## Usage with GitHub Enterprise Server or Cloud

You need to the `GITHUB_BASE_URL` input to point to your API endpoint to use this action with GitHub Enterprise Server or Cloud. For example:

```yaml
with:
  GITHUB_BASE_URL: https://github.acme-inc.com/api/v3 # for GitHub Enterprise Server
```
 or 

```yaml
with:
  GITHUB_BASE_URL: https://api.acme-inc.ghe.com # for GitHub Enterprise Cloud
```

### Multiple Coverage Files

You can specify multiple coverage files using glob patterns or newline-separated paths:

```yaml
# Using glob pattern
- name: Code Coverage Annotation
  uses: sgrankin/codecoverage@main
  with:
    GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
    COVERAGE_FILE_PATH: "**/coverage.out"
    COVERAGE_FORMAT: go

# Using multiple paths
- name: Code Coverage Annotation
  uses: sgrankin/codecoverage@main
  with:
    GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
    COVERAGE_FILE_PATH: |
      packages/frontend/coverage/lcov.info
      packages/backend/coverage/lcov.info
    COVERAGE_FORMAT: lcov
```

### Golang Workflow Example

```yaml
- name: Run tests with coverage
  run: go test -v ./... -coverprofile coverage.out

- name: Code Coverage Annotation
  uses: sgrankin/codecoverage@main
  with:
    GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
    COVERAGE_FILE_PATH: coverage.out
    COVERAGE_FORMAT: go
```

### Javascript/Typescript

Set up `npm run test:cov` in your `package.json` scripts to run `jest --coverage`, which will output Lcov formatted information to `coverage/lcov.info`.

### Other languages

* C++: GCC Gcov can output Lcov format; [this blog post](https://shenxianpeng.github.io/2021/07/gcov-example/) may help you get started.
* Ruby: Simplecov can output Lcov format when you add the [`simplecov-lcov`](https://github.com/fortissimo1997/simplecov-lcov) gem to your Gemfile. Make sure to set `SimpleCov::Formatter::LcovFormatter.config.report_with_single_file` to `true` and provide the path to the output file using `COVERAGE_FILE_PATH` as described above.

## Contributing

See [CONTRIBUTING.md](CONTRIBUTING.md) for development setup and guidelines.

## Acknowledgements

This fork is based on [ggilder/codecoverage](https://github.com/ggilder/codecoverage), which was originally based on [shravan097/codecoverage](https://github.com/shravan097/codecoverage).
