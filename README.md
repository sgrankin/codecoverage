![Build Status](https://github.com/sgrankin/codecoverage/actions/workflows/test.yml/badge.svg)

# Code Coverage Annotation

Reviewing test coverage information for a whole repository can be overwhelming
and hard to take action on. It's much more useful to catch gaps in coverage as
they're introduced to a repo, right in the context of pull requests!

All processing is done within Github Actions, no data is sent to an external server.

> **Note**: This is a fork of [ggilder/codecoverage](https://github.com/ggilder/codecoverage) with updated dependencies and additional improvements.

## Sample PR Annotation
<img width="1069" alt="Screen Shot 2022-06-26 at 7 11 21 PM" src="https://user-images.githubusercontent.com/23582455/175847244-dbed2fb3-70be-4bcd-a7d0-64197951c517.png">


## Inputs

| Key                  | Required | Default                  | Description                                                                                           |
| -------------------- | -------- | ------------------------ | ----------------------------------------------------------------------------------------------------- |
| `GITHUB_TOKEN`       | **yes**  | -                        | Github Token generated by Github Action workflow. You can pass this in as `${{secrets.GITHUB_TOKEN}}` |
| `GITHUB_BASE_URL`    | **no**   | `https://api.github.com` | Base URL for GitHub API. Required for GitHub Enterprise Server or Cloud.                              |
| `COVERAGE_FILE_PATH` | **yes**  | -                        | Path to coverage file(s). Supports glob patterns (including `**`) and multiple paths separated by newlines. |
| `COVERAGE_FORMAT`    | **no**   | `lcov`                   | Format of coverage file. May be `lcov`, `cobertura`, or `go`                                          |
| `STEP_SUMMARY`       | **no**   | `true`                   | Write a summary to the GitHub Actions step summary. Set to `false` to disable.                        |
| `mode`               | **no**   | auto-detected            | Operating mode: `pr-check` or `store-baseline`. See [Coverage Delta](#coverage-delta) for details.    |
| `calculate_delta`    | **no**   | `true`                   | Enable coverage delta calculation. Set to `false` to disable.                                         |
| `note_namespace`     | **no**   | `coverage`               | Custom namespace for git notes storage.                                                               |
| `delta_precision`    | **no**   | `2`                      | Number of decimal places for delta display.                                                           |

## Outputs

| Key                   | Description                                                    |
| --------------------- | -------------------------------------------------------------- |
| `coverage_percentage` | Overall code coverage percentage (e.g., `85.50`)               |
| `files_analyzed`      | Number of files with coverage data                             |
| `annotation_count`    | Number of annotations created for uncovered lines in the PR    |
| `coverage_delta`      | Change in coverage compared to baseline (e.g., `+2.50` or `-1.25`) |
| `baseline_percentage` | Baseline coverage percentage from git notes                    |
| `mode`                | The operating mode used (`pr-check` or `store-baseline`)       |

## Coverage Delta

This action can track coverage changes over time by storing baseline coverage data in git notes. When a pull request is opened, the action compares the current coverage against the baseline to show whether coverage has increased or decreased.

### How It Works

1. **On push to main**: The action runs in `store-baseline` mode, storing coverage data as a git note attached to the commit.
2. **On pull requests**: The action runs in `pr-check` mode, loading the baseline from the merge-base commit and calculating the delta.

### Workflow Configuration

To enable coverage deltas, you need to:

1. **Add `contents: write` permission** to push git notes
2. **Run the action on both PRs and pushes to main**

```yaml
name: Tests
on:
  pull_request:
  push:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required for git notes
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for merge-base detection

      - name: Run tests with coverage
        run: npm test -- --coverage

      - name: Code Coverage
        uses: sgrankin/codecoverage@main
        with:
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
          COVERAGE_FILE_PATH: coverage/lcov.info
```

### Summary Output

When a baseline is available, the summary shows the delta:

| Metric | Value |
| ------ | ----: |
| **Coverage** | 85.50% (â†‘2.50%) |
| **Baseline** | 83.00% |

### Mode Override

You can manually control the mode:

```yaml
# Force pr-check mode (useful for debugging)
- uses: sgrankin/codecoverage@main
  with:
    mode: pr-check
    # ...

# Force store-baseline mode (useful for scheduled runs)
- uses: sgrankin/codecoverage@main
  with:
    mode: store-baseline
    # ...
```

## Usage

Add the action to your workflow file like so, replacing the file path and
coverage format with values appropriate for your repo:

```yaml
- name: Code Coverage Annotation
  uses: sgrankin/codecoverage@main
  with:
    GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
    COVERAGE_FILE_PATH: "./coverage/lcov.info"
    COVERAGE_FORMAT: "lcov"
```

## Usage with GitHub Enterprise Server or Cloud

You need to the `GITHUB_BASE_URL` input to point to your API endpoint to use this action with GitHub Enterprise Server or Cloud. For example:

```yaml
with:
  GITHUB_BASE_URL: https://github.acme-inc.com/api/v3 # for GitHub Enterprise Server
```
 or 

```yaml
with:
  GITHUB_BASE_URL: https://api.acme-inc.ghe.com # for GitHub Enterprise Cloud
```

### Multiple Coverage Files

You can specify multiple coverage files using glob patterns or newline-separated paths:

```yaml
# Using glob pattern
- name: Code Coverage Annotation
  uses: sgrankin/codecoverage@main
  with:
    GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
    COVERAGE_FILE_PATH: "**/coverage.out"
    COVERAGE_FORMAT: go

# Using multiple paths
- name: Code Coverage Annotation
  uses: sgrankin/codecoverage@main
  with:
    GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
    COVERAGE_FILE_PATH: |
      packages/frontend/coverage/lcov.info
      packages/backend/coverage/lcov.info
    COVERAGE_FORMAT: lcov
```

### Golang Workflow Example

```yaml
- name: Run tests with coverage
  run: go test -v ./... -coverprofile coverage.out

- name: Code Coverage Annotation
  uses: sgrankin/codecoverage@main
  with:
    GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
    COVERAGE_FILE_PATH: coverage.out
    COVERAGE_FORMAT: go
```

### Javascript/Typescript

Set up `npm run test:cov` in your `package.json` scripts to run `jest --coverage`, which will output Lcov formatted information to `coverage/lcov.info`.

### Other languages

* C++: GCC Gcov can output Lcov format; [this blog post](https://shenxianpeng.github.io/2021/07/gcov-example/) may help you get started.
* Ruby: Simplecov can output Lcov format when you add the [`simplecov-lcov`](https://github.com/fortissimo1997/simplecov-lcov) gem to your Gemfile. Make sure to set `SimpleCov::Formatter::LcovFormatter.config.report_with_single_file` to `true` and provide the path to the output file using `COVERAGE_FILE_PATH` as described above.

## Contributing

See [CONTRIBUTING.md](CONTRIBUTING.md) for development setup and guidelines.

## Acknowledgements

This fork is based on [ggilder/codecoverage](https://github.com/ggilder/codecoverage), which was originally based on [shravan097/codecoverage](https://github.com/shravan097/codecoverage).
